"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.replaceTemplate = exports.processTemplate = undefined;

var _immutable = require("immutable");

var _ramdaFantasy = require("ramda-fantasy");

var _ramda = require("ramda");

var _ramda2 = _interopRequireDefault(_ramda);

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _errors = require("./errors");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const isDolar_960 = s_971 => s_971 && typeof s_971.match === "function" && s_971.match("identifier") && s_971.val() === "$";
const isDelimiter_961 = s_972 => s_972 && typeof s_972.match === "function" && s_972.match("delimiter");
const isBraces_962 = s_973 => s_973 && typeof s_973.match === "function" && s_973.match("braces");
const isParens_963 = s_974 => s_974 && typeof s_974.match === "function" && s_974.match("parens");
const isBrackets_964 = s_975 => s_975 && typeof s_975.match === "function" && s_975.match("brackets");
const insertIntoDelimiter_965 = _ramda2.default.cond([[isBraces_962, (s_976, r_977) => _syntax2.default.from("braces", r_977, s_976)], [isParens_963, (s_978, r_979) => _syntax2.default.from("parens", r_979, s_978)], [isBrackets_964, (s_980, r_981) => _syntax2.default.from("brackets", r_981, s_980)]]);
const process_966 = (acc_982, s_983) => {
  if (isBraces_962(s_983) && isDolar_960(acc_982.template.last())) {
    return { template: acc_982.template.push(_syntax2.default.from("braces", _immutable.List.of(_syntax2.default.from("number", acc_982.interp.size)), s_983)), interp: acc_982.interp.push(s_983.inner()) };
  } else if (isDelimiter_961(s_983)) {
    let innerResult = processTemplate_969(s_983.inner(), acc_982.interp);
    return { template: acc_982.template.push(insertIntoDelimiter_965(s_983, innerResult.template)), interp: innerResult.interp };
  } else {
    return { template: acc_982.template.push(s_983), interp: acc_982.interp };
  }
};
function cloneLineNumber_967(to_984, from_985) {
  if (from_985 && to_984) {
    if (typeof to_984.setLineNumber === "function") {
      return to_984.setLineNumber(from_985.lineNumber());
    } else if (_immutable.List.isList(to_984)) {
      return to_984.map(x_986 => cloneLineNumber_967(x_986, from_985));
    }
  }
  return to_984;
}
const replace_968 = (acc_987, s_988) => {
  let last_989 = acc_987.template.get(-1);
  let beforeLast_990 = acc_987.template.get(-2);
  if (isBraces_962(s_988) && isDolar_960(last_989)) {
    let index = s_988.inner().first().val();
    (0, _errors.assert)(acc_987.rep.size > index, "unknown replacement value");
    let replacement = cloneLineNumber_967(acc_987.rep.get(index), beforeLast_990);
    return { template: acc_987.template.pop().concat(replacement), rep: acc_987.rep };
  } else if (isDelimiter_961(s_988)) {
    let innerResult = replaceTemplate_970(s_988.inner(), acc_987.rep);
    return { template: acc_987.template.push(insertIntoDelimiter_965(s_988, innerResult)), rep: acc_987.rep };
  } else {
    return { template: acc_987.template.push(s_988), rep: acc_987.rep };
  }
};
function processTemplate_969(temp_991) {
  let interp_992 = arguments.length <= 1 || arguments[1] === undefined ? (0, _immutable.List)() : arguments[1];

  return temp_991.reduce(process_966, { template: (0, _immutable.List)(), interp: interp_992 });
}
function replaceTemplate_970(temp_993, rep_994) {
  return temp_993.reduce(replace_968, { template: (0, _immutable.List)(), rep: rep_994 }).template;
}
exports.processTemplate = processTemplate_969;
exports.replaceTemplate = replaceTemplate_970;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3RlbXBsYXRlLXByb2Nlc3Nvci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0EsTUFBTSxjQUFjLFNBQVMsU0FBUyxPQUFPLE1BQU0sS0FBYixLQUF1QixVQUFoQyxJQUE4QyxNQUFNLEtBQU4sQ0FBWSxZQUFaLENBQTlDLElBQTJFLE1BQU0sR0FBTixPQUFnQixHQUF4SDtBQUNBLE1BQU0sa0JBQWtCLFNBQVMsU0FBUyxPQUFPLE1BQU0sS0FBYixLQUF1QixVQUFoQyxJQUE4QyxNQUFNLEtBQU4sQ0FBWSxXQUFaLENBQS9FO0FBQ0EsTUFBTSxlQUFlLFNBQVMsU0FBUyxPQUFPLE1BQU0sS0FBYixLQUF1QixVQUFoQyxJQUE4QyxNQUFNLEtBQU4sQ0FBWSxRQUFaLENBQTVFO0FBQ0EsTUFBTSxlQUFlLFNBQVMsU0FBUyxPQUFPLE1BQU0sS0FBYixLQUF1QixVQUFoQyxJQUE4QyxNQUFNLEtBQU4sQ0FBWSxRQUFaLENBQTVFO0FBQ0EsTUFBTSxpQkFBaUIsU0FBUyxTQUFTLE9BQU8sTUFBTSxLQUFiLEtBQXVCLFVBQWhDLElBQThDLE1BQU0sS0FBTixDQUFZLFVBQVosQ0FBOUU7QUFDQSxNQUFNLDBCQUEwQixnQkFBRSxJQUFGLENBQU8sQ0FBQyxDQUFDLFlBQUQsRUFBZSxDQUFDLEtBQUQsRUFBUSxLQUFSLEtBQWtCLGlCQUFPLElBQVAsQ0FBWSxRQUFaLEVBQXNCLEtBQXRCLEVBQTZCLEtBQTdCLENBQWpDLENBQUQsRUFBd0UsQ0FBQyxZQUFELEVBQWUsQ0FBQyxLQUFELEVBQVEsS0FBUixLQUFrQixpQkFBTyxJQUFQLENBQVksUUFBWixFQUFzQixLQUF0QixFQUE2QixLQUE3QixDQUFqQyxDQUF4RSxFQUErSSxDQUFDLGNBQUQsRUFBaUIsQ0FBQyxLQUFELEVBQVEsS0FBUixLQUFrQixpQkFBTyxJQUFQLENBQVksVUFBWixFQUF3QixLQUF4QixFQUEr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QWpCLENBQXNCLEtBQXRCLENBQVgsRUFBeUMsS0FBSyxRQUFRLEdBQXRELEVBQVA7QUFDRDtBQUNGLENBZEQ7QUFlQSxTQUFTLG1CQUFULENBQTZCLFFBQTdCLEVBQTREO0FBQUEsTUFBckIsVUFBcUIseURBQVIsc0JBQVE7O0FBQzFELFNBQU8sU0FBUyxNQUFULENBQWdCLFdBQWhCLEVBQTZCLEVBQUMsVUFBVSxzQkFBWCxFQUFtQixRQUFRLFVBQTNCLEVBQTdCLENBQVA7QUFDRDtBQUNELFNBQVMsbUJBQVQsQ0FBNkIsUUFBN0IsRUFBdUMsT0FBdkMsRUFBZ0Q7QUFDOUMsU0FBTyxTQUFTLE1BQVQsQ0FBZ0IsV0FBaEIsRUFBNkIsRUFBQyxVQUFVLHNCQUFYLEVBQW1CLEtBQUssT0FBeEIsRUFBN0IsRUFBK0QsUUFBdEU7QUFDRDtRQUM4QixlLEdBQXZCLG1CO1FBQ3VCLGUsR0FBdkIsbUIiLCJmaWxlIjoidGVtcGxhdGUtcHJvY2Vzc29yLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQge01heWJlfSBmcm9tIFwicmFtZGEtZmFudGFzeVwiO1xuaW1wb3J0IF8gZnJvbSBcInJhbWRhXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IHthc3NlcnR9IGZyb20gXCIuL2Vycm9yc1wiO1xuY29uc3QgaXNEb2xhcl85NjAgPSBzXzk3MSA9PiBzXzk3MSAmJiB0eXBlb2Ygc185NzEubWF0Y2ggPT09IFwiZnVuY3Rpb25cIiAmJiBzXzk3MS5tYXRjaChcImlkZW50aWZpZXJcIikgJiYgc185NzEudmFsKCkgPT09IFwiJFwiO1xuY29uc3QgaXNEZWxpbWl0ZXJfOTYxID0gc185NzIgPT4gc185NzIgJiYgdHlwZW9mIHNfOTcyLm1hdGNoID09PSBcImZ1bmN0aW9uXCIgJiYgc185NzIubWF0Y2goXCJkZWxpbWl0ZXJcIik7XG5jb25zdCBpc0JyYWNlc185NjIgPSBzXzk3MyA9PiBzXzk3MyAmJiB0eXBlb2Ygc185NzMubWF0Y2ggPT09IFwiZnVuY3Rpb25cIiAmJiBzXzk3My5tYXRjaChcImJyYWNlc1wiKTtcbmNvbnN0IGlzUGFyZW5zXzk2MyA9IHNfOTc0ID0+IHNfOTc0ICYmIHR5cGVvZiBzXzk3NC5tYXRjaCA9PT0gXCJmdW5jdGlvblwiICYmIHNfOTc0Lm1hdGNoKFwicGFyZW5zXCIpO1xuY29uc3QgaXNCcmFja2V0c185NjQgPSBzXzk3NSA9PiBzXzk3NSAmJiB0eXBlb2Ygc185NzUubWF0Y2ggPT09IFwiZnVuY3Rpb25cIiAmJiBzXzk3NS5tYXRjaChcImJyYWNrZXRzXCIpO1xuY29uc3QgaW5zZXJ0SW50b0RlbGltaXRlcl85NjUgPSBfLmNvbmQoW1tpc0JyYWNlc185NjIsIChzXzk3Niwgcl85NzcpID0+IFN5bnRheC5mcm9tKFwiYnJhY2VzXCIsIHJfOTc3LCBzXzk3NildLCBbaXNQYXJlbnNfOTYzLCAoc185NzgsIHJfOTc5KSA9PiBTeW50YXguZnJvbShcInBhcmVuc1wiLCByXzk3OSwgc185NzgpXSwgW2lzQnJhY2tldHNfOTY0LCAoc185ODAsIHJfOTgxKSA9PiBTeW50YXguZnJvbShcImJyYWNrZXRzXCIsIHJfOTgxLCBzXzk4MCldXSk7XG5jb25zdCBwcm9jZXNzXzk2NiA9IChhY2NfOTgyLCBzXzk4MykgPT4ge1xuICBpZiAoaXNCcmFjZXNfOTYyKHNfOTgzKSAmJiBpc0RvbGFyXzk2MChhY2NfOTgyLnRlbXBsYXRlLmxhc3QoKSkpIHtcbiAgICByZXR1cm4ge3RlbXBsYXRlOiBhY2NfOTgyLnRlbXBsYXRlLnB1c2goU3ludGF4LmZyb20oXCJicmFjZXNcIiwgTGlzdC5vZihTeW50YXguZnJvbShcIm51bWJlclwiLCBhY2NfOTgyLmludGVycC5zaXplKSksIHNfOTgzKSksIGludGVycDogYWNjXzk4Mi5pbnRlcnAucHVzaChzXzk4My5pbm5lcigpKX07XG4gIH0gZWxzZSBpZiAoaXNEZWxpbWl0ZXJfOTYxKHNfOTgzKSkge1xuICAgIGxldCBpbm5lclJlc3VsdCA9IHByb2Nlc3NUZW1wbGF0ZV85Njkoc185ODMuaW5uZXIoKSwgYWNjXzk4Mi5pbnRlcnApO1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY185ODIudGVtcGxhdGUucHVzaChpbnNlcnRJbnRvRGVsaW1pdGVyXzk2NShzXzk4MywgaW5uZXJSZXN1bHQudGVtcGxhdGUpKSwgaW50ZXJwOiBpbm5lclJlc3VsdC5pbnRlcnB9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY185ODIudGVtcGxhdGUucHVzaChzXzk4MyksIGludGVycDogYWNjXzk4Mi5pbnRlcnB9O1xuICB9XG59O1xuZnVuY3Rpb24gY2xvbmVMaW5lTnVtYmVyXzk2Nyh0b185ODQsIGZyb21fOTg1KSB7XG4gIGlmIChmcm9tXzk4NSAmJiB0b185ODQpIHtcbiAgICBpZiAodHlwZW9mIHRvXzk4NC5zZXRMaW5lTnVtYmVyID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHJldHVybiB0b185ODQuc2V0TGluZU51bWJlcihmcm9tXzk4NS5saW5lTnVtYmVyKCkpO1xuICAgIH0gZWxzZSBpZiAoTGlzdC5pc0xpc3QodG9fOTg0KSkge1xuICAgICAgcmV0dXJuIHRvXzk4NC5tYXAoeF85ODYgPT4gY2xvbmVMaW5lTnVtYmVyXzk2Nyh4Xzk4NiwgZnJvbV85ODUpKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHRvXzk4NDtcbn1cbmNvbnN0IHJlcGxhY2VfOTY4ID0gKGFjY185ODcsIHNfOTg4KSA9PiB7XG4gIGxldCBsYXN0Xzk4OSA9IGFjY185ODcudGVtcGxhdGUuZ2V0KC0xKTtcbiAgbGV0IGJlZm9yZUxhc3RfOTkwID0gYWNjXzk4Ny50ZW1wbGF0ZS5nZXQoLTIpO1xuICBpZiAoaXNCcmFjZXNfOTYyKHNfOTg4KSAmJiBpc0RvbGFyXzk2MChsYXN0Xzk4OSkpIHtcbiAgICBsZXQgaW5kZXggPSBzXzk4OC5pbm5lcigpLmZpcnN0KCkudmFsKCk7XG4gICAgYXNzZXJ0KGFjY185ODcucmVwLnNpemUgPiBpbmRleCwgXCJ1bmtub3duIHJlcGxhY2VtZW50IHZhbHVlXCIpO1xuICAgIGxldCByZXBsYWNlbWVudCA9IGNsb25lTGluZU51bWJlcl85NjcoYWNjXzk4Ny5yZXAuZ2V0KGluZGV4KSwgYmVmb3JlTGFzdF85OTApO1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY185ODcudGVtcGxhdGUucG9wKCkuY29uY2F0KHJlcGxhY2VtZW50KSwgcmVwOiBhY2NfOTg3LnJlcH07XG4gIH0gZWxzZSBpZiAoaXNEZWxpbWl0ZXJfOTYxKHNfOTg4KSkge1xuICAgIGxldCBpbm5lclJlc3VsdCA9IHJlcGxhY2VUZW1wbGF0ZV85NzAoc185ODguaW5uZXIoKSwgYWNjXzk4Ny5yZXApO1xuICAgIHJldHVybiB7dGVtcGxhdGU6IGFjY185ODcudGVtcGxhdGUucHVzaChpbnNlcnRJbnRvRGVsaW1pdGVyXzk2NShzXzk4OCwgaW5uZXJSZXN1bHQpKSwgcmVwOiBhY2NfOTg3LnJlcH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHt0ZW1wbGF0ZTogYWNjXzk4Ny50ZW1wbGF0ZS5wdXNoKHNfOTg4KSwgcmVwOiBhY2NfOTg3LnJlcH07XG4gIH1cbn07XG5mdW5jdGlvbiBwcm9jZXNzVGVtcGxhdGVfOTY5KHRlbXBfOTkxLCBpbnRlcnBfOTkyID0gTGlzdCgpKSB7XG4gIHJldHVybiB0ZW1wXzk5MS5yZWR1Y2UocHJvY2Vzc185NjYsIHt0ZW1wbGF0ZTogTGlzdCgpLCBpbnRlcnA6IGludGVycF85OTJ9KTtcbn1cbmZ1bmN0aW9uIHJlcGxhY2VUZW1wbGF0ZV85NzAodGVtcF85OTMsIHJlcF85OTQpIHtcbiAgcmV0dXJuIHRlbXBfOTkzLnJlZHVjZShyZXBsYWNlXzk2OCwge3RlbXBsYXRlOiBMaXN0KCksIHJlcDogcmVwXzk5NH0pLnRlbXBsYXRlO1xufVxuZXhwb3J0IHtwcm9jZXNzVGVtcGxhdGVfOTY5IGFzIHByb2Nlc3NUZW1wbGF0ZX07XG5leHBvcnQge3JlcGxhY2VUZW1wbGF0ZV85NzAgYXMgcmVwbGFjZVRlbXBsYXRlfSJdfQ==