"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Modules = exports.Module = undefined;

var _immutable = require("immutable");

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _tokenExpander = require("./token-expander.js");

var _tokenExpander2 = _interopRequireDefault(_tokenExpander);

var _termExpander = require("./term-expander.js");

var _termExpander2 = _interopRequireDefault(_termExpander);

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _symbol = require("./symbol");

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _loadSyntax = require("./load-syntax");

var _compiler = require("./compiler");

var _compiler2 = _interopRequireDefault(_compiler);

var _transforms = require("./transforms");

var _scope = require("./scope");

var _errors = require("./errors");

var _hygieneUtils = require("./hygiene-utils");

var _syntax = require("./syntax");

var _utilsDirname = require("utils-dirname");

var _utilsDirname2 = _interopRequireDefault(_utilsDirname);

var _ramda = require("ramda");

var _ = _interopRequireWildcard(_ramda);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Module_469 {
  constructor(moduleSpecifier_474, isNative_475, importEntries_476, exportEntries_477, pragmas_478, body_479) {
    this.moduleSpecifier = moduleSpecifier_474;
    this.isNative = isNative_475;
    this.importEntries = importEntries_476;
    this.exportEntries = exportEntries_477;
    this.pragmas = pragmas_478;
    this.body = body_479;
  }
}
const findBindingIdentifierName_470 = term_480 => {
  (0, _errors.assert)(term_480.name, `not implemented yet for type ${ term_480.type }`);
  return term_480.name;
};
const convertExport_471 = term_481 => {
  let declaration_482 = term_481.declaration;
  let bindings_483 = [];
  if ((0, _terms.isVariableDeclaration)(declaration_482)) {
    bindings_483 = declaration_482.declarators.map(decl_485 => findBindingIdentifierName_470(decl_485.binding));
  } else if ((0, _terms.isFunctionDeclaration)(declaration_482) || (0, _terms.isClassDeclaration)(declaration_482)) {
    bindings_483.push(findBindingIdentifierName_470(declaration_482.name));
  }
  let namedExports_484 = bindings_483.map(binding_486 => {
    return new _terms2.default("ExportSpecifier", { name: null, exportedName: binding_486 });
  });
  return new _terms2.default("ExportFrom", { moduleSpecifier: null, namedExports: (0, _immutable.List)(namedExports_484) });
};
const pragmaRegep_472 = /^\s*#\w*/;
class Modules_473 {
  constructor(context_487) {
    this.compiledModules = new Map();
    this.context = context_487;
    this.context.modules = this;
  }
  loadString(str_488) {
    let checkPragma_489 = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    let hasPragma_490 = pragmaRegep_472.test(str_488);
    if (checkPragma_489 && !hasPragma_490) {
      return { isNative: true, body: (0, _immutable.List)() };
    }
    return { isNative: !hasPragma_490, body: new _shiftReader2.default(str_488).read() };
  }
  load(path_491) {
    return this.loadString(this.context.moduleLoader(path_491));
  }
  compile(mod_492, path_493) {
    let stxl_494 = mod_492.body;
    let outScope_495 = (0, _scope.freshScope)("outsideEdge");
    let inScope_496 = (0, _scope.freshScope)(`insideEdge0`);
    let compiler_497 = new _compiler2.default(0, new _env2.default(), new _store2.default(), _.merge(this.context, { currentScope: [outScope_495, inScope_496], cwd: path_493 === "<<entrypoint>>" ? this.context.cwd : (0, _utilsDirname2.default)(path_493) }));
    let terms_498 = compiler_497.compile(stxl_494.map(s_503 => s_503.addScope(outScope_495, this.context.bindings, _syntax.ALL_PHASES).addScope(inScope_496, this.context.bindings, 0)));
    let importEntries_499 = [];
    let exportEntries_500 = [];
    let pragmas_501 = [];
    let filteredTerms_502 = terms_498.reduce((acc_504, t_505) => {
      return _.cond([[_terms.isImport, t_506 => {
        importEntries_499.push(t_506);
        return acc_504;
      }], [_terms.isExport, t_507 => {
        if (t_507.declaration) {
          exportEntries_500.push(convertExport_471(t_507));
          if ((0, _terms.isVariableDeclaration)(t_507.declaration)) {
            return acc_504.concat(new _terms2.default("VariableDeclarationStatement", { declaration: t_507.declaration }));
          }
          return acc_504.concat(t_507.declaration);
        }
        exportEntries_500.push(t_507);
        return acc_504;
      }], [_terms.isPragma, t_508 => {
        pragmas_501.push(t_508);
        return acc_504;
      }], [_.T, t_509 => acc_504.concat(t_509)]])(t_505);
    }, (0, _immutable.List)());
    return new Module_469(path_493, mod_492.isNative, (0, _immutable.List)(importEntries_499), (0, _immutable.List)(exportEntries_500), (0, _immutable.List)(pragmas_501), filteredTerms_502);
  }
  compileEntrypoint(source_510, filename_511) {
    let enforcePragma_512 = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

    let stxl_513 = this.loadString(source_510, false);
    if (enforcePragma_512 && stxl_513.isNative) {
      throw new Error(`Entrypoint ${ filename_511 } must begin with #lang pragma`);
    }
    return this.getAtPhase("<<entrypoint>>", 0, this.context.cwd, stxl_513);
  }
  getAtPhase(rawPath_514, phase_515, cwd_516) {
    let rawStxl_517 = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

    let path_518 = rawPath_514 === "<<entrypoint>>" ? rawPath_514 : this.context.moduleResolver(rawPath_514, cwd_516);
    let mapKey_519 = `${ path_518 }:${ phase_515 }`;
    if (!this.compiledModules.has(mapKey_519)) {
      if (phase_515 === 0) {
        let stxl = rawStxl_517 != null ? rawStxl_517 : this.load(path_518);
        this.compiledModules.set(mapKey_519, this.compile(stxl, path_518));
      } else {
        let rawMod = this.getAtPhase(rawPath_514, 0, cwd_516, rawStxl_517);
        let scope = (0, _scope.freshScope)(`insideEdge${ phase_515 }`);
        this.compiledModules.set(mapKey_519, new Module_469(rawMod.moduleSpecifier, false, rawMod.importEntries.map(term_520 => term_520.addScope(scope, this.context.bindings, phase_515)), rawMod.exportEntries.map(term_521 => term_521.addScope(scope, this.context.bindings, phase_515)), rawMod.pragmas, rawMod.body.map(term_522 => term_522.addScope(scope, this.context.bindings, phase_515))));
      }
    }
    return this.compiledModules.get(mapKey_519);
  }
  has(rawPath_523) {
    let phase_524 = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

    let path_525 = rawPath_523 === "<<entrypoint>>" ? rawPath_523 : this.context.moduleResolver(rawPath_523, this.context.cwd);
    let key_526 = `${ path_525 }:${ phase_524 }`;
    return this.compiledModules.has(key_526) && !this.compiledModules.get(key_526).isNative;
  }
  registerSyntaxDeclaration(term_527, phase_528, store_529) {
    term_527.declarators.forEach(decl_530 => {
      let val_531 = (0, _loadSyntax.evalCompiletimeValue)(decl_530.init.gen(), _.merge(this.context, { phase: phase_528 + 1, store: store_529 }));
      (0, _hygieneUtils.collectBindings)(decl_530.binding).forEach(stx_532 => {
        if (phase_528 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_532.val());
          this.context.bindings.add(stx_532, { binding: newBinding, phase: phase_528, skipDup: false });
        }
        let resolvedName_533 = stx_532.resolve(phase_528);
        store_529.set(resolvedName_533, new _transforms.CompiletimeTransform(val_531));
      });
    });
  }
  registerVariableDeclaration(term_534, phase_535, store_536) {
    term_534.declarators.forEach(decl_537 => {
      (0, _hygieneUtils.collectBindings)(decl_537.binding).forEach(stx_538 => {
        if (phase_535 !== 0) {
          let newBinding = (0, _symbol.gensym)(stx_538.val());
          this.context.bindings.add(stx_538, { binding: newBinding, phase: phase_535, skipDup: term_534.kind === "var" });
        }
        let resolvedName_539 = stx_538.resolve(phase_535);
        store_536.set(resolvedName_539, new _transforms.VarBindingTransform(stx_538));
      });
    });
  }
  registerFunctionOrClass(term_540, phase_541, store_542) {
    (0, _hygieneUtils.collectBindings)(term_540.name).forEach(stx_543 => {
      if (phase_541 !== 0) {
        let newBinding = (0, _symbol.gensym)(stx_543.val());
        this.context.bindings.add(stx_543, { binding: newBinding, phase: phase_541, skipDup: false });
      }
      let resolvedName_544 = stx_543.resolve(phase_541);
      store_542.set(resolvedName_544, new _transforms.VarBindingTransform(stx_543));
    });
  }
  visit(mod_545, phase_546, store_547) {
    mod_545.body.forEach(term_548 => {
      if ((0, _terms.isSyntaxDeclarationStatement)(term_548)) {
        this.registerSyntaxDeclaration(term_548.declaration, phase_546, store_547);
      }
    });
    return store_547;
  }
  invoke(mod_549, phase_550, store_551) {
    let body_552 = mod_549.body.filter(_.complement(_terms.isCompiletimeStatement)).map(term_554 => {
      term_554 = term_554.gen();
      if ((0, _terms.isVariableDeclarationStatement)(term_554)) {
        this.registerVariableDeclaration(term_554.declaration, phase_550, store_551);
      } else if ((0, _terms.isFunctionDeclaration)(term_554)) {
        this.registerFunctionOrClass(term_554, phase_550, store_551);
      }
      return term_554;
    });
    let exportsObj_553 = (0, _loadSyntax.evalRuntimeValues)(body_552, _.merge(this.context, { store: store_551, phase: phase_550 }));
    return store_551;
  }
}
exports.Module = Module_469;
exports.Modules = Modules_473;
//# sourceMappingURL=data:application/json;base64,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LEVBQTRDO0FBQzFDLGFBQUsseUJBQUwsQ0FBK0IsU0FBUyxXQUF4QyxFQUFxRCxTQUFyRCxFQUFnRSxTQUFoRTtBQUNEO0FBQ0YsS0FKRDtBQUtBLFdBQU8sU0FBUDtBQUNEO0FBQ0QsU0FBTyxPQUFQLEVBQWdCLFNBQWhCLEVBQTJCLFNBQTNCLEVBQXNDO0FBQ3BDLFFBQUksV0FBVyxRQUFRLElBQVIsQ0FBYSxNQUFiLENBQW9CLEVBQUUsVUFBRiwrQkFBcEIsRUFBMEQsR0FBMUQsQ0FBOEQsWUFBWTtBQUN2RixpQkFBVyxTQUFTLEdBQVQsRUFBWDtBQUNBLFVBQUksMkNBQStCLFFBQS9CLENBQUosRUFBOEM7QUFDNUMsYUFBSywyQkFBTCxDQUFpQyxTQUFTLFdBQTFDLEVBQXVELFNBQXZELEVBQWtFLFNBQWxFO0FBQ0QsT0FGRCxNQUVPLElBQUksa0NBQXNCLFFBQXRCLENBQUosRUFBcUM7QUFDMUMsYUFBSyx1QkFBTCxDQUE2QixRQUE3QixFQUF1QyxTQUF2QyxFQUFrRCxTQUFsRDtBQUNEO0FBQ0QsYUFBTyxRQUFQO0FBQ0QsS0FSYyxDQUFmO0FBU0EsUUFBSSxpQkFBaUIsbUNBQWtCLFFBQWxCLEVBQTRCLEVBQUUsS0FBRixDQUFRLEtBQUssT0FBYixFQUFzQixFQUFDLE9BQU8sU0FBUixFQUFtQixPQUFPLFNBQTFCLEVBQXRCLENBQTVCLENBQXJCO0FBQ0EsV0FBTyxTQUFQO0FBQ0Q7QUFoSWU7UUFrSUksTSxHQUFkLFU7UUFDZSxPLEdBQWYsVyIsImZpbGUiOiJtb2R1bGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtMaXN0fSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgRW52IGZyb20gXCIuL2VudlwiO1xuaW1wb3J0IFN0b3JlIGZyb20gXCIuL3N0b3JlXCI7XG5pbXBvcnQgUmVhZGVyIGZyb20gXCIuL3NoaWZ0LXJlYWRlclwiO1xuaW1wb3J0IFRva2VuRXhwYW5kZXIgZnJvbSBcIi4vdG9rZW4tZXhwYW5kZXIuanNcIjtcbmltcG9ydCBUZXJtRXhwYW5kZXIgZnJvbSBcIi4vdGVybS1leHBhbmRlci5qc1wiO1xuaW1wb3J0IEJpbmRpbmdNYXAgZnJvbSBcIi4vYmluZGluZy1tYXAuanNcIjtcbmltcG9ydCB7Z2Vuc3ltfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCBUZXJtLCB7aXNFT0YsIGlzQmluZGluZ0lkZW50aWZpZXIsIGlzRnVuY3Rpb25EZWNsYXJhdGlvbiwgaXNGdW5jdGlvbkV4cHJlc3Npb24sIGlzRnVuY3Rpb25UZXJtLCBpc0Z1bmN0aW9uV2l0aE5hbWUsIGlzU3ludGF4RGVjbGFyYXRpb24sIGlzU3ludGF4cmVjRGVjbGFyYXRpb24sIGlzVmFyaWFibGVEZWNsYXJhdGlvbiwgaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50LCBpc0ltcG9ydCwgaXNFeHBvcnQsIGlzRXhwb3J0RnJvbSwgaXNFeHBvcnRBbGxGcm9tLCBpc0V4cG9ydERlZmF1bHQsIGlzRXhwb3J0U3ludGF4LCBpc1N5bnRheERlY2xhcmF0aW9uU3RhdGVtZW50LCBpc1ByYWdtYSwgaXNDb21waWxldGltZURlY2xhcmF0aW9uLCBpc0NvbXBpbGV0aW1lU3RhdGVtZW50LCBpc0NsYXNzRGVjbGFyYXRpb259IGZyb20gXCIuL3Rlcm1zXCI7XG5pbXBvcnQge2V2YWxDb21waWxldGltZVZhbHVlLCBldmFsUnVudGltZVZhbHVlc30gZnJvbSBcIi4vbG9hZC1zeW50YXhcIjtcbmltcG9ydCBDb21waWxlciBmcm9tIFwiLi9jb21waWxlclwiO1xuaW1wb3J0IHtWYXJCaW5kaW5nVHJhbnNmb3JtLCBDb21waWxldGltZVRyYW5zZm9ybX0gZnJvbSBcIi4vdHJhbnNmb3Jtc1wiO1xuaW1wb3J0IHtTY29wZSwgZnJlc2hTY29wZX0gZnJvbSBcIi4vc2NvcGVcIjtcbmltcG9ydCB7YXNzZXJ0fSBmcm9tIFwiLi9lcnJvcnNcIjtcbmltcG9ydCB7Y29sbGVjdEJpbmRpbmdzfSBmcm9tIFwiLi9oeWdpZW5lLXV0aWxzXCI7XG5pbXBvcnQge0FMTF9QSEFTRVN9IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IGRpcm5hbWUgZnJvbSBcInV0aWxzLWRpcm5hbWVcIjtcbmltcG9ydCAgKiBhcyBfIGZyb20gXCJyYW1kYVwiO1xuY2xhc3MgTW9kdWxlXzQ2OSB7XG4gIGNvbnN0cnVjdG9yKG1vZHVsZVNwZWNpZmllcl80NzQsIGlzTmF0aXZlXzQ3NSwgaW1wb3J0RW50cmllc180NzYsIGV4cG9ydEVudHJpZXNfNDc3LCBwcmFnbWFzXzQ3OCwgYm9keV80NzkpIHtcbiAgICB0aGlzLm1vZHVsZVNwZWNpZmllciA9IG1vZHVsZVNwZWNpZmllcl80NzQ7XG4gICAgdGhpcy5pc05hdGl2ZSA9IGlzTmF0aXZlXzQ3NTtcbiAgICB0aGlzLmltcG9ydEVudHJpZXMgPSBpbXBvcnRFbnRyaWVzXzQ3NjtcbiAgICB0aGlzLmV4cG9ydEVudHJpZXMgPSBleHBvcnRFbnRyaWVzXzQ3NztcbiAgICB0aGlzLnByYWdtYXMgPSBwcmFnbWFzXzQ3ODtcbiAgICB0aGlzLmJvZHkgPSBib2R5XzQ3OTtcbiAgfVxufVxuY29uc3QgZmluZEJpbmRpbmdJZGVudGlmaWVyTmFtZV80NzAgPSB0ZXJtXzQ4MCA9PiB7XG4gIGFzc2VydCh0ZXJtXzQ4MC5uYW1lLCBgbm90IGltcGxlbWVudGVkIHlldCBmb3IgdHlwZSAke3Rlcm1fNDgwLnR5cGV9YCk7XG4gIHJldHVybiB0ZXJtXzQ4MC5uYW1lO1xufTtcbmNvbnN0IGNvbnZlcnRFeHBvcnRfNDcxID0gdGVybV80ODEgPT4ge1xuICBsZXQgZGVjbGFyYXRpb25fNDgyID0gdGVybV80ODEuZGVjbGFyYXRpb247XG4gIGxldCBiaW5kaW5nc180ODMgPSBbXTtcbiAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbihkZWNsYXJhdGlvbl80ODIpKSB7XG4gICAgYmluZGluZ3NfNDgzID0gZGVjbGFyYXRpb25fNDgyLmRlY2xhcmF0b3JzLm1hcChkZWNsXzQ4NSA9PiBmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQ3MChkZWNsXzQ4NS5iaW5kaW5nKSk7XG4gIH0gZWxzZSBpZiAoaXNGdW5jdGlvbkRlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ4MikgfHwgaXNDbGFzc0RlY2xhcmF0aW9uKGRlY2xhcmF0aW9uXzQ4MikpIHtcbiAgICBiaW5kaW5nc180ODMucHVzaChmaW5kQmluZGluZ0lkZW50aWZpZXJOYW1lXzQ3MChkZWNsYXJhdGlvbl80ODIubmFtZSkpO1xuICB9XG4gIGxldCBuYW1lZEV4cG9ydHNfNDg0ID0gYmluZGluZ3NfNDgzLm1hcChiaW5kaW5nXzQ4NiA9PiB7XG4gICAgcmV0dXJuIG5ldyBUZXJtKFwiRXhwb3J0U3BlY2lmaWVyXCIsIHtuYW1lOiBudWxsLCBleHBvcnRlZE5hbWU6IGJpbmRpbmdfNDg2fSk7XG4gIH0pO1xuICByZXR1cm4gbmV3IFRlcm0oXCJFeHBvcnRGcm9tXCIsIHttb2R1bGVTcGVjaWZpZXI6IG51bGwsIG5hbWVkRXhwb3J0czogTGlzdChuYW1lZEV4cG9ydHNfNDg0KX0pO1xufTtcbmNvbnN0IHByYWdtYVJlZ2VwXzQ3MiA9IC9eXFxzKiNcXHcqLztcbmNsYXNzIE1vZHVsZXNfNDczIHtcbiAgY29uc3RydWN0b3IoY29udGV4dF80ODcpIHtcbiAgICB0aGlzLmNvbXBpbGVkTW9kdWxlcyA9IG5ldyBNYXA7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dF80ODc7XG4gICAgdGhpcy5jb250ZXh0Lm1vZHVsZXMgPSB0aGlzO1xuICB9XG4gIGxvYWRTdHJpbmcoc3RyXzQ4OCwgY2hlY2tQcmFnbWFfNDg5ID0gdHJ1ZSkge1xuICAgIGxldCBoYXNQcmFnbWFfNDkwID0gcHJhZ21hUmVnZXBfNDcyLnRlc3Qoc3RyXzQ4OCk7XG4gICAgaWYgKGNoZWNrUHJhZ21hXzQ4OSAmJiAhaGFzUHJhZ21hXzQ5MCkge1xuICAgICAgcmV0dXJuIHtpc05hdGl2ZTogdHJ1ZSwgYm9keTogTGlzdCgpfTtcbiAgICB9XG4gICAgcmV0dXJuIHtpc05hdGl2ZTogIWhhc1ByYWdtYV80OTAsIGJvZHk6IG5ldyBSZWFkZXIoc3RyXzQ4OCkucmVhZCgpfTtcbiAgfVxuICBsb2FkKHBhdGhfNDkxKSB7XG4gICAgcmV0dXJuIHRoaXMubG9hZFN0cmluZyh0aGlzLmNvbnRleHQubW9kdWxlTG9hZGVyKHBhdGhfNDkxKSk7XG4gIH1cbiAgY29tcGlsZShtb2RfNDkyLCBwYXRoXzQ5Mykge1xuICAgIGxldCBzdHhsXzQ5NCA9IG1vZF80OTIuYm9keTtcbiAgICBsZXQgb3V0U2NvcGVfNDk1ID0gZnJlc2hTY29wZShcIm91dHNpZGVFZGdlXCIpO1xuICAgIGxldCBpblNjb3BlXzQ5NiA9IGZyZXNoU2NvcGUoYGluc2lkZUVkZ2UwYCk7XG4gICAgbGV0IGNvbXBpbGVyXzQ5NyA9IG5ldyBDb21waWxlcigwLCBuZXcgRW52LCBuZXcgU3RvcmUsIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7Y3VycmVudFNjb3BlOiBbb3V0U2NvcGVfNDk1LCBpblNjb3BlXzQ5Nl0sIGN3ZDogcGF0aF80OTMgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHRoaXMuY29udGV4dC5jd2QgOiBkaXJuYW1lKHBhdGhfNDkzKX0pKTtcbiAgICBsZXQgdGVybXNfNDk4ID0gY29tcGlsZXJfNDk3LmNvbXBpbGUoc3R4bF80OTQubWFwKHNfNTAzID0+IHNfNTAzLmFkZFNjb3BlKG91dFNjb3BlXzQ5NSwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCBBTExfUEhBU0VTKS5hZGRTY29wZShpblNjb3BlXzQ5NiwgdGhpcy5jb250ZXh0LmJpbmRpbmdzLCAwKSkpO1xuICAgIGxldCBpbXBvcnRFbnRyaWVzXzQ5OSA9IFtdO1xuICAgIGxldCBleHBvcnRFbnRyaWVzXzUwMCA9IFtdO1xuICAgIGxldCBwcmFnbWFzXzUwMSA9IFtdO1xuICAgIGxldCBmaWx0ZXJlZFRlcm1zXzUwMiA9IHRlcm1zXzQ5OC5yZWR1Y2UoKGFjY181MDQsIHRfNTA1KSA9PiB7XG4gICAgICByZXR1cm4gXy5jb25kKFtbaXNJbXBvcnQsIHRfNTA2ID0+IHtcbiAgICAgICAgaW1wb3J0RW50cmllc180OTkucHVzaCh0XzUwNik7XG4gICAgICAgIHJldHVybiBhY2NfNTA0O1xuICAgICAgfV0sIFtpc0V4cG9ydCwgdF81MDcgPT4ge1xuICAgICAgICBpZiAodF81MDcuZGVjbGFyYXRpb24pIHtcbiAgICAgICAgICBleHBvcnRFbnRyaWVzXzUwMC5wdXNoKGNvbnZlcnRFeHBvcnRfNDcxKHRfNTA3KSk7XG4gICAgICAgICAgaWYgKGlzVmFyaWFibGVEZWNsYXJhdGlvbih0XzUwNy5kZWNsYXJhdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBhY2NfNTA0LmNvbmNhdChuZXcgVGVybShcIlZhcmlhYmxlRGVjbGFyYXRpb25TdGF0ZW1lbnRcIiwge2RlY2xhcmF0aW9uOiB0XzUwNy5kZWNsYXJhdGlvbn0pKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFjY181MDQuY29uY2F0KHRfNTA3LmRlY2xhcmF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBleHBvcnRFbnRyaWVzXzUwMC5wdXNoKHRfNTA3KTtcbiAgICAgICAgcmV0dXJuIGFjY181MDQ7XG4gICAgICB9XSwgW2lzUHJhZ21hLCB0XzUwOCA9PiB7XG4gICAgICAgIHByYWdtYXNfNTAxLnB1c2godF81MDgpO1xuICAgICAgICByZXR1cm4gYWNjXzUwNDtcbiAgICAgIH1dLCBbXy5ULCB0XzUwOSA9PiBhY2NfNTA0LmNvbmNhdCh0XzUwOSldXSkodF81MDUpO1xuICAgIH0sIExpc3QoKSk7XG4gICAgcmV0dXJuIG5ldyBNb2R1bGVfNDY5KHBhdGhfNDkzLCBtb2RfNDkyLmlzTmF0aXZlLCBMaXN0KGltcG9ydEVudHJpZXNfNDk5KSwgTGlzdChleHBvcnRFbnRyaWVzXzUwMCksIExpc3QocHJhZ21hc181MDEpLCBmaWx0ZXJlZFRlcm1zXzUwMik7XG4gIH1cbiAgY29tcGlsZUVudHJ5cG9pbnQoc291cmNlXzUxMCwgZmlsZW5hbWVfNTExLCBlbmZvcmNlUHJhZ21hXzUxMiA9IGZhbHNlKSB7XG4gICAgbGV0IHN0eGxfNTEzID0gdGhpcy5sb2FkU3RyaW5nKHNvdXJjZV81MTAsIGZhbHNlKTtcbiAgICBpZiAoZW5mb3JjZVByYWdtYV81MTIgJiYgc3R4bF81MTMuaXNOYXRpdmUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRW50cnlwb2ludCAke2ZpbGVuYW1lXzUxMX0gbXVzdCBiZWdpbiB3aXRoICNsYW5nIHByYWdtYWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBdFBoYXNlKFwiPDxlbnRyeXBvaW50Pj5cIiwgMCwgdGhpcy5jb250ZXh0LmN3ZCwgc3R4bF81MTMpO1xuICB9XG4gIGdldEF0UGhhc2UocmF3UGF0aF81MTQsIHBoYXNlXzUxNSwgY3dkXzUxNiwgcmF3U3R4bF81MTcgPSBudWxsKSB7XG4gICAgbGV0IHBhdGhfNTE4ID0gcmF3UGF0aF81MTQgPT09IFwiPDxlbnRyeXBvaW50Pj5cIiA/IHJhd1BhdGhfNTE0IDogdGhpcy5jb250ZXh0Lm1vZHVsZVJlc29sdmVyKHJhd1BhdGhfNTE0LCBjd2RfNTE2KTtcbiAgICBsZXQgbWFwS2V5XzUxOSA9IGAke3BhdGhfNTE4fToke3BoYXNlXzUxNX1gO1xuICAgIGlmICghdGhpcy5jb21waWxlZE1vZHVsZXMuaGFzKG1hcEtleV81MTkpKSB7XG4gICAgICBpZiAocGhhc2VfNTE1ID09PSAwKSB7XG4gICAgICAgIGxldCBzdHhsID0gcmF3U3R4bF81MTcgIT0gbnVsbCA/IHJhd1N0eGxfNTE3IDogdGhpcy5sb2FkKHBhdGhfNTE4KTtcbiAgICAgICAgdGhpcy5jb21waWxlZE1vZHVsZXMuc2V0KG1hcEtleV81MTksIHRoaXMuY29tcGlsZShzdHhsLCBwYXRoXzUxOCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGV0IHJhd01vZCA9IHRoaXMuZ2V0QXRQaGFzZShyYXdQYXRoXzUxNCwgMCwgY3dkXzUxNiwgcmF3U3R4bF81MTcpO1xuICAgICAgICBsZXQgc2NvcGUgPSBmcmVzaFNjb3BlKGBpbnNpZGVFZGdlJHtwaGFzZV81MTV9YCk7XG4gICAgICAgIHRoaXMuY29tcGlsZWRNb2R1bGVzLnNldChtYXBLZXlfNTE5LCBuZXcgTW9kdWxlXzQ2OShyYXdNb2QubW9kdWxlU3BlY2lmaWVyLCBmYWxzZSwgcmF3TW9kLmltcG9ydEVudHJpZXMubWFwKHRlcm1fNTIwID0+IHRlcm1fNTIwLmFkZFNjb3BlKHNjb3BlLCB0aGlzLmNvbnRleHQuYmluZGluZ3MsIHBoYXNlXzUxNSkpLCByYXdNb2QuZXhwb3J0RW50cmllcy5tYXAodGVybV81MjEgPT4gdGVybV81MjEuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNTE1KSksIHJhd01vZC5wcmFnbWFzLCByYXdNb2QuYm9keS5tYXAodGVybV81MjIgPT4gdGVybV81MjIuYWRkU2NvcGUoc2NvcGUsIHRoaXMuY29udGV4dC5iaW5kaW5ncywgcGhhc2VfNTE1KSkpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmdldChtYXBLZXlfNTE5KTtcbiAgfVxuICBoYXMocmF3UGF0aF81MjMsIHBoYXNlXzUyNCA9IDApIHtcbiAgICBsZXQgcGF0aF81MjUgPSByYXdQYXRoXzUyMyA9PT0gXCI8PGVudHJ5cG9pbnQ+PlwiID8gcmF3UGF0aF81MjMgOiB0aGlzLmNvbnRleHQubW9kdWxlUmVzb2x2ZXIocmF3UGF0aF81MjMsIHRoaXMuY29udGV4dC5jd2QpO1xuICAgIGxldCBrZXlfNTI2ID0gYCR7cGF0aF81MjV9OiR7cGhhc2VfNTI0fWA7XG4gICAgcmV0dXJuIHRoaXMuY29tcGlsZWRNb2R1bGVzLmhhcyhrZXlfNTI2KSAmJiAhdGhpcy5jb21waWxlZE1vZHVsZXMuZ2V0KGtleV81MjYpLmlzTmF0aXZlO1xuICB9XG4gIHJlZ2lzdGVyU3ludGF4RGVjbGFyYXRpb24odGVybV81MjcsIHBoYXNlXzUyOCwgc3RvcmVfNTI5KSB7XG4gICAgdGVybV81MjcuZGVjbGFyYXRvcnMuZm9yRWFjaChkZWNsXzUzMCA9PiB7XG4gICAgICBsZXQgdmFsXzUzMSA9IGV2YWxDb21waWxldGltZVZhbHVlKGRlY2xfNTMwLmluaXQuZ2VuKCksIF8ubWVyZ2UodGhpcy5jb250ZXh0LCB7cGhhc2U6IHBoYXNlXzUyOCArIDEsIHN0b3JlOiBzdG9yZV81Mjl9KSk7XG4gICAgICBjb2xsZWN0QmluZGluZ3MoZGVjbF81MzAuYmluZGluZykuZm9yRWFjaChzdHhfNTMyID0+IHtcbiAgICAgICAgaWYgKHBoYXNlXzUyOCAhPT0gMCkge1xuICAgICAgICAgIGxldCBuZXdCaW5kaW5nID0gZ2Vuc3ltKHN0eF81MzIudmFsKCkpO1xuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzUzMiwge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV81MjgsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV81MzMgPSBzdHhfNTMyLnJlc29sdmUocGhhc2VfNTI4KTtcbiAgICAgICAgc3RvcmVfNTI5LnNldChyZXNvbHZlZE5hbWVfNTMzLCBuZXcgQ29tcGlsZXRpbWVUcmFuc2Zvcm0odmFsXzUzMSkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbiAgcmVnaXN0ZXJWYXJpYWJsZURlY2xhcmF0aW9uKHRlcm1fNTM0LCBwaGFzZV81MzUsIHN0b3JlXzUzNikge1xuICAgIHRlcm1fNTM0LmRlY2xhcmF0b3JzLmZvckVhY2goZGVjbF81MzcgPT4ge1xuICAgICAgY29sbGVjdEJpbmRpbmdzKGRlY2xfNTM3LmJpbmRpbmcpLmZvckVhY2goc3R4XzUzOCA9PiB7XG4gICAgICAgIGlmIChwaGFzZV81MzUgIT09IDApIHtcbiAgICAgICAgICBsZXQgbmV3QmluZGluZyA9IGdlbnN5bShzdHhfNTM4LnZhbCgpKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQuYmluZGluZ3MuYWRkKHN0eF81MzgsIHtiaW5kaW5nOiBuZXdCaW5kaW5nLCBwaGFzZTogcGhhc2VfNTM1LCBza2lwRHVwOiB0ZXJtXzUzNC5raW5kID09PSBcInZhclwifSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJlc29sdmVkTmFtZV81MzkgPSBzdHhfNTM4LnJlc29sdmUocGhhc2VfNTM1KTtcbiAgICAgICAgc3RvcmVfNTM2LnNldChyZXNvbHZlZE5hbWVfNTM5LCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTM4KSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICByZWdpc3RlckZ1bmN0aW9uT3JDbGFzcyh0ZXJtXzU0MCwgcGhhc2VfNTQxLCBzdG9yZV81NDIpIHtcbiAgICBjb2xsZWN0QmluZGluZ3ModGVybV81NDAubmFtZSkuZm9yRWFjaChzdHhfNTQzID0+IHtcbiAgICAgIGlmIChwaGFzZV81NDEgIT09IDApIHtcbiAgICAgICAgbGV0IG5ld0JpbmRpbmcgPSBnZW5zeW0oc3R4XzU0My52YWwoKSk7XG4gICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGQoc3R4XzU0Mywge2JpbmRpbmc6IG5ld0JpbmRpbmcsIHBoYXNlOiBwaGFzZV81NDEsIHNraXBEdXA6IGZhbHNlfSk7XG4gICAgICB9XG4gICAgICBsZXQgcmVzb2x2ZWROYW1lXzU0NCA9IHN0eF81NDMucmVzb2x2ZShwaGFzZV81NDEpO1xuICAgICAgc3RvcmVfNTQyLnNldChyZXNvbHZlZE5hbWVfNTQ0LCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShzdHhfNTQzKSk7XG4gICAgfSk7XG4gIH1cbiAgdmlzaXQobW9kXzU0NSwgcGhhc2VfNTQ2LCBzdG9yZV81NDcpIHtcbiAgICBtb2RfNTQ1LmJvZHkuZm9yRWFjaCh0ZXJtXzU0OCA9PiB7XG4gICAgICBpZiAoaXNTeW50YXhEZWNsYXJhdGlvblN0YXRlbWVudCh0ZXJtXzU0OCkpIHtcbiAgICAgICAgdGhpcy5yZWdpc3RlclN5bnRheERlY2xhcmF0aW9uKHRlcm1fNTQ4LmRlY2xhcmF0aW9uLCBwaGFzZV81NDYsIHN0b3JlXzU0Nyk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHN0b3JlXzU0NztcbiAgfVxuICBpbnZva2UobW9kXzU0OSwgcGhhc2VfNTUwLCBzdG9yZV81NTEpIHtcbiAgICBsZXQgYm9keV81NTIgPSBtb2RfNTQ5LmJvZHkuZmlsdGVyKF8uY29tcGxlbWVudChpc0NvbXBpbGV0aW1lU3RhdGVtZW50KSkubWFwKHRlcm1fNTU0ID0+IHtcbiAgICAgIHRlcm1fNTU0ID0gdGVybV81NTQuZ2VuKCk7XG4gICAgICBpZiAoaXNWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50KHRlcm1fNTU0KSkge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtXzU1NC5kZWNsYXJhdGlvbiwgcGhhc2VfNTUwLCBzdG9yZV81NTEpO1xuICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uRGVjbGFyYXRpb24odGVybV81NTQpKSB7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybV81NTQsIHBoYXNlXzU1MCwgc3RvcmVfNTUxKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0ZXJtXzU1NDtcbiAgICB9KTtcbiAgICBsZXQgZXhwb3J0c09ial81NTMgPSBldmFsUnVudGltZVZhbHVlcyhib2R5XzU1MiwgXy5tZXJnZSh0aGlzLmNvbnRleHQsIHtzdG9yZTogc3RvcmVfNTUxLCBwaGFzZTogcGhhc2VfNTUwfSkpO1xuICAgIHJldHVybiBzdG9yZV81NTE7XG4gIH1cbn1cbmV4cG9ydCB7TW9kdWxlXzQ2OSBhcyBNb2R1bGV9O1xuZXhwb3J0IHtNb2R1bGVzXzQ3MyBhcyBNb2R1bGVzfSJdfQ==