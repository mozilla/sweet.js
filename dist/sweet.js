"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compile = exports.parse = exports.expand = undefined;

var _shiftReader = require("./shift-reader");

var _shiftReader2 = _interopRequireDefault(_shiftReader);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _env = require("./env");

var _env2 = _interopRequireDefault(_env);

var _shiftReducer = require("shift-reducer");

var _shiftReducer2 = _interopRequireDefault(_shiftReducer);

var _parseReducer = require("./parse-reducer");

var _parseReducer2 = _interopRequireDefault(_parseReducer);

var _shiftCodegen = require("shift-codegen");

var _shiftCodegen2 = _interopRequireDefault(_shiftCodegen);

var _scope = require("./scope");

var _bindingMap = require("./binding-map.js");

var _bindingMap2 = _interopRequireDefault(_bindingMap);

var _terms = require("./terms");

var _terms2 = _interopRequireDefault(_terms);

var _modules = require("./modules");

var _babelCore = require("babel-core");

var _nodeModuleResolver = require("./node-module-resolver");

var _nodeModuleResolver2 = _interopRequireDefault(_nodeModuleResolver);

var _nodeModuleLoader = require("./node-module-loader");

var _nodeModuleLoader2 = _interopRequireDefault(_nodeModuleLoader);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function expand_797(source_800) {
  let options_801 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let bindings_802 = new _bindingMap2.default();
  let modules_803 = new _modules.Modules({ bindings: bindings_802, cwd: options_801.cwd || process.cwd(), filename: options_801.filename, transform: options_801.transform || _babelCore.transform || function (c_806) {
      return { code: c_806 };
    }, moduleResolver: options_801.moduleResolver || _nodeModuleResolver2.default, moduleLoader: options_801.moduleLoader || _nodeModuleLoader2.default });
  let compiledMod_804 = modules_803.compileEntrypoint(source_800, options_801.filename, options_801.enforcePragma);
  let nativeImports_805 = compiledMod_804.importEntries.filter(imp_807 => !modules_803.has(imp_807.moduleSpecifier.val()));
  return new _terms2.default("Module", { directives: (0, _immutable.List)(), items: nativeImports_805.concat(compiledMod_804.body).concat(compiledMod_804.exportEntries.interpose(new _terms2.default("EmptyStatement", {}))) });
}
function parse_798(source_808, options_809) {
  let includeImports_810 = arguments.length <= 2 || arguments[2] === undefined ? true : arguments[2];

  return (0, _shiftReducer2.default)(new _parseReducer2.default({ phase: 0 }), expand_797(source_808, options_809).gen({ includeImports: includeImports_810 }));
}
function compile_799(source_811) {
  let options_812 = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  let ast_813 = parse_798(source_811, options_812, options_812.includeImports);
  let gen_814 = (0, _shiftCodegen2.default)(ast_813, new _shiftCodegen.FormattedCodeGen());
  return options_812.transform && !options_812.noBabel ? options_812.transform(gen_814, { babelrc: true, filename: options_812.filename }) : { code: gen_814 };
}
exports.expand = expand_797;
exports.parse = parse_798;
exports.compile = compile_799;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3N3ZWV0L3N3ZWV0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBQ0EsU0FBUyxVQUFULENBQW9CLFVBQXBCLEVBQWtEO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDaEQsTUFBSSxlQUFlLDBCQUFuQjtBQUNBLE1BQUksY0FBYyxxQkFBWSxFQUFDLFVBQVUsWUFBWCxFQUF5QixLQUFLLFlBQVksR0FBWixJQUFtQixRQUFRLEdBQVIsRUFBakQsRUFBZ0UsVUFBVSxZQUFZLFFBQXRGLEVBQWdHLFdBQVcsWUFBWSxTQUFaLDRCQUEyQyxVQUFVLEtBQVYsRUFBaUI7QUFDbk0sYUFBTyxFQUFDLE1BQU0sS0FBUCxFQUFQO0FBQ0QsS0FGNkIsRUFFM0IsZ0JBQWdCLFlBQVksY0FBWixnQ0FGVyxFQUVpQyxjQUFjLFlBQVksWUFBWiw4QkFGL0MsRUFBWixDQUFsQjtBQUdBLE1BQUksa0JBQWtCLFlBQVksaUJBQVosQ0FBOEIsVUFBOUIsRUFBMEMsWUFBWSxRQUF0RCxFQUFnRSxZQUFZLGFBQTVFLENBQXRCO0FBQ0EsTUFBSSxvQkFBb0IsZ0JBQWdCLGFBQWhCLENBQThCLE1BQTlCLENBQXFDLFdBQVcsQ0FBQyxZQUFZLEdBQVosQ0FBZ0IsUUFBUSxlQUFSLENBQXdCLEdBQXhCLEVBQWhCLENBQWpELENBQXhCO0FBQ0EsU0FBTyxvQkFBUyxRQUFULEVBQW1CLEVBQUMsWUFBWSxzQkFBYixFQUFxQixPQUFPLGtCQUFrQixNQUFsQixDQUF5QixnQkFBZ0IsSUFBekMsRUFBK0MsTUFBL0MsQ0FBc0QsZ0JBQWdCLGFBQWhCLENBQThCLFNBQTlCLENBQXdDLG9CQUFTLGdCQUFULEVBQTJCLEVBQTNCLENBQXhDLENBQXRELENBQTVCLEVBQW5CLENBQVA7QUFDRDtBQUNELFNBQVMsU0FBVCxDQUFtQixVQUFuQixFQUErQixXQUEvQixFQUF1RTtBQUFBLE1BQTNCLGtCQUEyQix5REFBTixJQUFNOztBQUNyRSxTQUFPLDRCQUFPLDJCQUFpQixFQUFDLE9BQU8sQ0FBUixFQUFqQixDQUFQLEVBQXFDLFdBQVcsVUFBWCxFQUF1QixXQUF2QixFQUFvQyxHQUFwQyxDQUF3QyxFQUFDLGdCQUFnQixrQkFBakIsRUFBeEMsQ0FBckMsQ0FBUDtBQUNEO0FBQ0QsU0FBUyxXQUFULENBQXFCLFVBQXJCLEVBQW1EO0FBQUEsTUFBbEIsV0FBa0IseURBQUosRUFBSTs7QUFDakQsTUFBSSxVQUFVLFVBQVUsVUFBVixFQUFzQixXQUF0QixFQUFtQyxZQUFZLGNBQS9DLENBQWQ7QUFDQSxNQUFJLFVBQVUsNEJBQVEsT0FBUixFQUFpQixvQ0FBakIsQ0FBZDtBQUNBLFNBQU8sWUFBWSxTQUFaLElBQXlCLENBQUMsWUFBWSxPQUF0QyxHQUFnRCxZQUFZLFNBQVosQ0FBc0IsT0FBdEIsRUFBK0IsRUFBQyxTQUFTLElBQVYsRUFBZ0IsVUFBVSxZQUFZLFFBQXRDLEVBQS9CLENBQWhELEdBQWtJLEVBQUMsTUFBTSxPQUFQLEVBQXpJO0FBQ0Q7UUFDcUIsTSxHQUFkLFU7UUFDYSxLLEdBQWIsUztRQUNlLE8sR0FBZixXIiwiZmlsZSI6InN3ZWV0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWRlciBmcm9tIFwiLi9zaGlmdC1yZWFkZXJcIjtcbmltcG9ydCB7TGlzdH0gZnJvbSBcImltbXV0YWJsZVwiO1xuaW1wb3J0IFN5bnRheCBmcm9tIFwiLi9zeW50YXhcIjtcbmltcG9ydCBFbnYgZnJvbSBcIi4vZW52XCI7XG5pbXBvcnQgcmVkdWNlIGZyb20gXCJzaGlmdC1yZWR1Y2VyXCI7XG5pbXBvcnQgUGFyc2VSZWR1Y2VyIGZyb20gXCIuL3BhcnNlLXJlZHVjZXJcIjtcbmltcG9ydCBjb2RlZ2VuLCB7Rm9ybWF0dGVkQ29kZUdlbn0gZnJvbSBcInNoaWZ0LWNvZGVnZW5cIjtcbmltcG9ydCB7U2NvcGUsIGZyZXNoU2NvcGV9IGZyb20gXCIuL3Njb3BlXCI7XG5pbXBvcnQgQmluZGluZ01hcCBmcm9tIFwiLi9iaW5kaW5nLW1hcC5qc1wiO1xuaW1wb3J0IFRlcm0gZnJvbSBcIi4vdGVybXNcIjtcbmltcG9ydCB7TW9kdWxlc30gZnJvbSBcIi4vbW9kdWxlc1wiO1xuaW1wb3J0IHt0cmFuc2Zvcm0gYXMgYmFiZWxUcmFuc2Zvcm19IGZyb20gXCJiYWJlbC1jb3JlXCI7XG5pbXBvcnQgbm9kZVJlc29sdmVyIGZyb20gXCIuL25vZGUtbW9kdWxlLXJlc29sdmVyXCI7XG5pbXBvcnQgbm9kZUxvYWRlciBmcm9tIFwiLi9ub2RlLW1vZHVsZS1sb2FkZXJcIjtcbmZ1bmN0aW9uIGV4cGFuZF83OTcoc291cmNlXzgwMCwgb3B0aW9uc184MDEgPSB7fSkge1xuICBsZXQgYmluZGluZ3NfODAyID0gbmV3IEJpbmRpbmdNYXA7XG4gIGxldCBtb2R1bGVzXzgwMyA9IG5ldyBNb2R1bGVzKHtiaW5kaW5nczogYmluZGluZ3NfODAyLCBjd2Q6IG9wdGlvbnNfODAxLmN3ZCB8fCBwcm9jZXNzLmN3ZCgpLCBmaWxlbmFtZTogb3B0aW9uc184MDEuZmlsZW5hbWUsIHRyYW5zZm9ybTogb3B0aW9uc184MDEudHJhbnNmb3JtIHx8IGJhYmVsVHJhbnNmb3JtIHx8IGZ1bmN0aW9uIChjXzgwNikge1xuICAgIHJldHVybiB7Y29kZTogY184MDZ9O1xuICB9LCBtb2R1bGVSZXNvbHZlcjogb3B0aW9uc184MDEubW9kdWxlUmVzb2x2ZXIgfHwgbm9kZVJlc29sdmVyLCBtb2R1bGVMb2FkZXI6IG9wdGlvbnNfODAxLm1vZHVsZUxvYWRlciB8fCBub2RlTG9hZGVyfSk7XG4gIGxldCBjb21waWxlZE1vZF84MDQgPSBtb2R1bGVzXzgwMy5jb21waWxlRW50cnlwb2ludChzb3VyY2VfODAwLCBvcHRpb25zXzgwMS5maWxlbmFtZSwgb3B0aW9uc184MDEuZW5mb3JjZVByYWdtYSk7XG4gIGxldCBuYXRpdmVJbXBvcnRzXzgwNSA9IGNvbXBpbGVkTW9kXzgwNC5pbXBvcnRFbnRyaWVzLmZpbHRlcihpbXBfODA3ID0+ICFtb2R1bGVzXzgwMy5oYXMoaW1wXzgwNy5tb2R1bGVTcGVjaWZpZXIudmFsKCkpKTtcbiAgcmV0dXJuIG5ldyBUZXJtKFwiTW9kdWxlXCIsIHtkaXJlY3RpdmVzOiBMaXN0KCksIGl0ZW1zOiBuYXRpdmVJbXBvcnRzXzgwNS5jb25jYXQoY29tcGlsZWRNb2RfODA0LmJvZHkpLmNvbmNhdChjb21waWxlZE1vZF84MDQuZXhwb3J0RW50cmllcy5pbnRlcnBvc2UobmV3IFRlcm0oXCJFbXB0eVN0YXRlbWVudFwiLCB7fSkpKX0pO1xufVxuZnVuY3Rpb24gcGFyc2VfNzk4KHNvdXJjZV84MDgsIG9wdGlvbnNfODA5LCBpbmNsdWRlSW1wb3J0c184MTAgPSB0cnVlKSB7XG4gIHJldHVybiByZWR1Y2UobmV3IFBhcnNlUmVkdWNlcih7cGhhc2U6IDB9KSwgZXhwYW5kXzc5Nyhzb3VyY2VfODA4LCBvcHRpb25zXzgwOSkuZ2VuKHtpbmNsdWRlSW1wb3J0czogaW5jbHVkZUltcG9ydHNfODEwfSkpO1xufVxuZnVuY3Rpb24gY29tcGlsZV83OTkoc291cmNlXzgxMSwgb3B0aW9uc184MTIgPSB7fSkge1xuICBsZXQgYXN0XzgxMyA9IHBhcnNlXzc5OChzb3VyY2VfODExLCBvcHRpb25zXzgxMiwgb3B0aW9uc184MTIuaW5jbHVkZUltcG9ydHMpO1xuICBsZXQgZ2VuXzgxNCA9IGNvZGVnZW4oYXN0XzgxMywgbmV3IEZvcm1hdHRlZENvZGVHZW4pO1xuICByZXR1cm4gb3B0aW9uc184MTIudHJhbnNmb3JtICYmICFvcHRpb25zXzgxMi5ub0JhYmVsID8gb3B0aW9uc184MTIudHJhbnNmb3JtKGdlbl84MTQsIHtiYWJlbHJjOiB0cnVlLCBmaWxlbmFtZTogb3B0aW9uc184MTIuZmlsZW5hbWV9KSA6IHtjb2RlOiBnZW5fODE0fTtcbn1cbmV4cG9ydCB7ZXhwYW5kXzc5NyBhcyBleHBhbmR9O1xuZXhwb3J0IHtwYXJzZV83OTggYXMgcGFyc2V9O1xuZXhwb3J0IHtjb21waWxlXzc5OSBhcyBjb21waWxlfSJdfQ==